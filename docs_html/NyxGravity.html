

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Gravity &mdash; Nyx 20.10
 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/theme_overrides.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"TeX": {"Macros": {"kth": "{{k_\\mathrm{th}}}", "gcc": "{\\mathrm{g~cm^{-3}}}", "cms": "{\\mathrm{cm~s^{-1}}}", "presunit": "{\\mathrm{dyn~cm^{-2}}}", "accelunit": "{\\mathrm{cm~s^{-2}}}", "ergg": "{\\mathrm{erg~g^{-1}}}", "Ab": "{{\\bf A}}", "eb": "{{\\bf e}}", "Fb": "{{\\bf F}}", "gb": "{{\\bf g}}", "Hb": "{{\\bf H}}", "ib": "{{\\bf i}}", "Ib": "{{\\bf I}}", "Kb": "{{\\bf K}}", "lb": "{{\\bf l}}", "Lb": "{{\\bf L}}", "nb": "{{\\bf n}}", "Pb": "{{\\bf P}}", "Qb": "{{\\bf Q}}", "rb": "{{\\bf r}}", "Rb": "{{\\bf R}}", "Sb": "{{\\bf S}}", "ub": "{{\\bf u}}", "Ub": "{{\\bf U}}", "xb": "{{\\bf x}}", "dt": "{\\Delta t}", "omegadot": "{\\dot\\omega}", "inp": "{{\\rm in}}", "outp": "{{\\rm out}}", "sync": "{{\\rm sync}}", "half": "{\\frac{1}{2}}", "myhalf": "{\\half}", "nph": "{{n+\\myhalf}}", "kpp": "{\\ensuremath{\\kappa_{\\mathrm{P}}}}", "kpr": "{\\ensuremath{\\kappa_{\\mathrm{R}}}}", "kpf": "{\\ensuremath{\\kappa_{\\mathrm{F}}}}", "vb": "{\\boldsymbol{v}}", "vbt": "{\\widetilde{\\vb}}", "rbt": "{\\widetilde{\\rb}}", "ob": "{\\boldsymbol{\\omega}}", "nablab": "{\\boldsymbol{\\nabla}}"}}, "tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Multigrid Inputs" href="InputsMultigrid.html" />
    <link rel="prev" title="Radiative Heating and Cooling" href="NyxHeatCool.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> Nyx
          

          
          </a>

          
            
            
              <div class="version">
                20.10

              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Nyx basics</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="NyxPreface.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="NyxIntroduction.html">Introduction to Nyx</a></li>
<li class="toctree-l1"><a class="reference internal" href="NyxGettingStarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="ManagingGridHierarchy_Chapter.html">Gridding and Load Balancing</a></li>
<li class="toctree-l1"><a class="reference internal" href="NyxEquations.html">Hydrodynamic Equations in Comoving Coordinates</a></li>
<li class="toctree-l1"><a class="reference internal" href="Particles.html">Dark matter particles</a></li>
<li class="toctree-l1"><a class="reference internal" href="NyxHeatCool.html">Radiative Heating and Cooling</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Gravity</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#integration-strategy">Integration Strategy</a></li>
<li class="toctree-l3"><a class="reference internal" href="#controls">Controls</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#poisson-approximation">Poisson Approximation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#hydrodynamics-source-terms">Hydrodynamics Source Terms</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="InputsMultigrid.html">Multigrid Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="NightlyTests.html">Nightly Regression Tests</a></li>
</ul>
<p class="caption"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="filelist.html">File list</a></li>
<li class="toctree-l1"><a class="reference internal" href="classlist.html">Class list</a></li>
<li class="toctree-l1"><a class="reference internal" href="namespacelist.html">Namespace list</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Nyx</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Gravity</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/NyxGravity.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="gravity">
<h1>Gravity<a class="headerlink" href="#gravity" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<div class="section" id="integration-strategy">
<h3>Integration Strategy<a class="headerlink" href="#integration-strategy" title="Permalink to this headline">¶</a></h3>
<p>Nyx uses subcycling to integrate levels at different timesteps.
The gravity algorithm needs to respect this. Self-gravity is computed
via multigrid. At coarse-fine interfaces, the stencil used in the
Laplacian understands the coarse-fine interface and is different than
the stencil used in the interior.</p>
<p>There are two types of solves that we discuss with AMR:</p>
<ul class="simple">
<li><em>composite solve</em> : This is a multilevel solve, starting at
a coarse level (usually level 0) and solving for the potential on
all levels up to the finest level.</li>
<li><em>level solve</em> : This solves for the potential only on
a particular level. Finer levels are ignored. At coarse-fine
interfaces, the data from the coarse levels acts as Dirichlet
boundary conditions for the current-level-solve.</li>
</ul>
<p>Briefly:</p>
<ul>
<li><p class="first">At the beginning of a simulation, we do a multilevel composite
solve (if <code class="docutils literal notranslate"><span class="pre">gravity.no_composite</span></code> = 0).</p>
<p>We also do a multilevel composite solve after each regrid.</p>
</li>
<li><p class="first">The old-time gravity on the coarse level is defined based on
this composite solve, but we also do a level solve on the coarse
level, and use it to determine the difference between the composite
solve and the level solve, and store that in a MultiFab.</p>
</li>
<li><p class="first">After the hydro advance on the coarse level, we do another level
solve, and use the (level solve - compositive solve) as a lagged
predictor of how much we need to add back to that level solve to get
an effective new-time value for phi on the coarse level, and that’s
what defines the phi used for the new-time gravity</p>
</li>
<li><p class="first">Then we do the fine grid timestep(s), each using the same
strategy</p>
</li>
<li><p class="first">At an AMR synchronization step across levels, if we’re
choosing to synchronize the gravitational field across levels
(<code class="docutils literal notranslate"><span class="pre">gravity.no_sync</span></code> = 0) we then do a solve starting from the coarse
grid that adjusts for the mismatch between the fine-grid phi and
the coarse-grid phi, as well as the mismatch between the fine-grid
density fluxes and the coarse-grid density fluxes, and add the
resulting sync solve phi to both the coarse and the fine level</p>
<p>Thus, to within the gravity error tolerance, you get the same final
result as if you had done a full composite solve at the end of the
timestep (assuming <code class="docutils literal notranslate"><span class="pre">gravity.no_sync</span></code> = 0).</p>
</li>
</ul>
<p>If you do <code class="docutils literal notranslate"><span class="pre">gravity.no_composite</span></code> = 1, then you never do a full
multilevel solve, and the gravity on any level is defined only by the
solve on that level. The only time this would be appropriate is if
the fine level(s) cover essentially all of the mass on the grid for
all time.</p>
</div>
<div class="section" id="controls">
<h3>Controls<a class="headerlink" href="#controls" title="Permalink to this headline">¶</a></h3>
<p>In order to use gravity, we must always set:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">USE_GRAV</span><span class="o">=</span><span class="n">TRUE</span>
</pre></div>
</div>
<p>in the GNUmakefile and</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nyx</span><span class="o">.</span><span class="n">do_grav</span><span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
<p>in the inputs file.</p>
</div>
</div>
<div class="section" id="poisson-approximation">
<h2>Poisson Approximation<a class="headerlink" href="#poisson-approximation" title="Permalink to this headline">¶</a></h2>
<p>In Nyx we always compute gravity by solving a Poisson equation on the mesh hierarchy.
To define the gravitational vector we set</p>
<blockquote>
<div><div class="math notranslate nohighlight">
\[\mathbf{g}(\mathbf{x},t) = -\nabla \phi\]</div>
<p>where</p>
<div class="math notranslate nohighlight">
\[\mathbf{\Delta} \phi = \frac{4 \pi G}{a} (\rho - \overline{\rho}) \label{eq:Self Gravity}\]</div>
</div></blockquote>
<p>where <span class="math notranslate nohighlight">\(\overline{\rho}\)</span> is the average of <span class="math notranslate nohighlight">\(\rho\)</span> over the entire domain if we assume triply periodic boundary conditions,
and <span class="math notranslate nohighlight">\(a(t)\)</span> is the scale of the universe as a function of time.</p>
</div>
<div class="section" id="hydrodynamics-source-terms">
<h2>Hydrodynamics Source Terms<a class="headerlink" href="#hydrodynamics-source-terms" title="Permalink to this headline">¶</a></h2>
<p>There are several options to incorporate the effects of gravity into
the hydrodynamics system. The main parameter here is
<code class="docutils literal notranslate"><span class="pre">Nyx.grav_source_type</span></code>.</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">Nyx.grav_source_type</span></code> = 1 : we use a standard
predictor-corrector formalism for updating the momentum and
energy. Specifically, our first update is equal to <span class="math notranslate nohighlight">\(\Delta t
\times \mathbf{S}^n\)</span> , where <span class="math notranslate nohighlight">\(\mathbf{S}^n\)</span> is the value of
the source terms at the old-time (which is usually called time-level
<span class="math notranslate nohighlight">\(n\)</span>). At the end of the timestep, we do a corrector step where
we subtract off <span class="math notranslate nohighlight">\(\Delta t / 2 \times \mathbf{S}^n\)</span> and add on
<span class="math notranslate nohighlight">\(\Delta t / 2 \times \mathbf{S}^{n+1}\)</span>, so that at the end of
the timestep the source term is properly time centered.</li>
</ul>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">Nyx.grav_source_type</span></code> = 3 : we do the same momentum update as
the previous, but for the energy update, we put all of the work
into updating the kinetic energy alone. In particular, we explicitly
ensure that <span class="math notranslate nohighlight">\((rho e)\)</span> maintains the same, and update
<span class="math notranslate nohighlight">\((rho K)\)</span> with the work due to gravity, adding the new kinetic
energy to the old internal energy to determine the final total gas
energy. The physical motivation is that work should be done on the
velocity, and should not directly update the temperature—only
indirectly through things like shocks.</li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="InputsMultigrid.html" class="btn btn-neutral float-right" title="Multigrid Inputs" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="NyxHeatCool.html" class="btn btn-neutral float-left" title="Radiative Heating and Cooling" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2018, Nyx development team

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>