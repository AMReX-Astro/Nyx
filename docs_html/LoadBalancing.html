

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Load Balancing &mdash; Nyx  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/graphviz.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"TeX": {"Macros": {"kth": "{{k_\\mathrm{th}}}", "gcc": "{\\mathrm{g~cm^{-3}}}", "cms": "{\\mathrm{cm~s^{-1}}}", "presunit": "{\\mathrm{dyn~cm^{-2}}}", "accelunit": "{\\mathrm{cm~s^{-2}}}", "ergg": "{\\mathrm{erg~g^{-1}}}", "Ab": "{{\\bf A}}", "eb": "{{\\bf e}}", "Fb": "{{\\bf F}}", "gb": "{{\\bf g}}", "Hb": "{{\\bf H}}", "ib": "{{\\bf i}}", "Ib": "{{\\bf I}}", "Kb": "{{\\bf K}}", "lb": "{{\\bf l}}", "Lb": "{{\\bf L}}", "nb": "{{\\bf n}}", "Pb": "{{\\bf P}}", "Qb": "{{\\bf Q}}", "rb": "{{\\bf r}}", "Rb": "{{\\bf R}}", "Sb": "{{\\bf S}}", "ub": "{{\\bf u}}", "Ub": "{{\\bf U}}", "xb": "{{\\bf x}}", "dt": "{\\Delta t}", "omegadot": "{\\dot\\omega}", "inp": "{{\\rm in}}", "outp": "{{\\rm out}}", "sync": "{{\\rm sync}}", "half": "{\\frac{1}{2}}", "myhalf": "{\\half}", "nph": "{{n+\\myhalf}}", "kpp": "{\\ensuremath{\\kappa_{\\mathrm{P}}}}", "kpr": "{\\ensuremath{\\kappa_{\\mathrm{R}}}}", "kpf": "{\\ensuremath{\\kappa_{\\mathrm{F}}}}", "vb": "{\\boldsymbol{v}}", "vbt": "{\\widetilde{\\vb}}", "rbt": "{\\widetilde{\\rb}}", "ob": "{\\boldsymbol{\\omega}}", "nablab": "{\\boldsymbol{\\nabla}}"}}, "tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Gravity" href="NyxGravity.html" />
    <link rel="prev" title="Grid Creation" href="GridCreation.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Nyx
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Nyx basics</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="NyxPreface.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="NyxCitation.html">Citation</a></li>
<li class="toctree-l1"><a class="reference internal" href="NyxGettingStarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="NyxUnits.html">Units and Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="NyxInputs.html">Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="ICs.html">Initial conditions</a></li>
<li class="toctree-l1"><a class="reference internal" href="Refinement.html">Refinement Criteria</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="ManagingGridHierarchy_Chapter.html">Gridding and Load Balancing</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="GridCreation.html">Grid Creation</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Load Balancing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#load-balancing-the-hydrodynamical-mesh">Load Balancing the Hydrodynamical Mesh</a></li>
<li class="toctree-l2"><a class="reference internal" href="#load-balancing-the-dark-matter-particles">Load Balancing the Dark Matter Particles</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="NyxGravity.html">Gravity</a></li>
<li class="toctree-l1"><a class="reference internal" href="NyxEquations.html">Hydrodynamic Equations in Comoving Coordinates</a></li>
<li class="toctree-l1"><a class="reference internal" href="NyxSplitting.html">Hydrodynamical and Heating-Cooling Splitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="NyxHeatCool.html">Radiative Heating and Cooling</a></li>
<li class="toctree-l1"><a class="reference internal" href="NyxForcing.html">Stochastic Forcing</a></li>
<li class="toctree-l1"><a class="reference internal" href="Particles.html">Dark matter particles</a></li>
<li class="toctree-l1"><a class="reference internal" href="InSitu.html">In situ analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="PostProcessing.html">Analyzing Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="NightlyTests.html">Nightly Regression Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="Debugging.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="Development.html">Work in Progress</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Nyx</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="ManagingGridHierarchy_Chapter.html">Gridding and Load Balancing</a> &raquo;</li>
        
      <li>Load Balancing</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/LoadBalancing.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="load-balancing">
<span id="sec-load-balancing"></span><h1>Load Balancing<a class="headerlink" href="#load-balancing" title="Permalink to this headline">¶</a></h1>
<p>The process of load balancing is typically independent of the process of grid creation;
the inputs to load balancing are a given set of grids with a set of weights
assigned to each grid.</p>
<p>Single-level load balancing algorithms are sequentially applied to each AMR level independently,
and the resulting distributions are mapped onto the ranks taking into account the weights
already assigned to them (assign heaviest set of grids to the least loaded rank)</p>
<p>Options supported by AMReX include the following; the default is SFC:</p>
<ul class="simple">
<li>Knapsack: the default weight of a grid in the knapsack algorithm is the number of grid cells,
but AMReX supports the option to pass an array of weights – one per grid – or alternatively
to pass in a MultiFab of weights per cell which is used to compute the weight per grid</li>
<li>SFC: enumerate grids with a space-filling Z-morton curve, then partition the
resulting ordering across ranks in a way that balances the load</li>
<li>Round-robin: sort grids and assign them to ranks in round-robin fashion – specifically
FAB <em>i</em> is owned by CPU <em>i</em> %N where N is the total number of MPI ranks.</li>
</ul>
</div>
<div class="section" id="load-balancing-the-hydrodynamical-mesh">
<h1>Load Balancing the Hydrodynamical Mesh<a class="headerlink" href="#load-balancing-the-hydrodynamical-mesh" title="Permalink to this headline">¶</a></h1>
<p>For Nyx, the DistributionMapping defaults to using a SFC strategy.
Setting the DistributionMapping to use a different strategy is controlled
by flags beginning with DistributionMapping:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">DistributionMapping</span><span class="o">.</span><span class="n">strategy</span> <span class="o">=</span> <span class="p">{</span><span class="n">KNAPSACK</span><span class="p">,</span> <span class="n">SFC</span><span class="p">,</span> <span class="n">ROUNDROBIN</span><span class="p">}</span>
<span class="n">DistributionMapping</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">}</span>
</pre></div>
</div>
<p>These flags take effect whenever the Regrid operation is called on the mesh,
typically either when <code class="docutils literal notranslate"><span class="pre">amr.regrid_int</span></code> is reached in a multilevel simulation or if
<code class="docutils literal notranslate"><span class="pre">amr.regrid_on_restart=1</span></code>.</p>
</div>
<div class="section" id="load-balancing-the-dark-matter-particles">
<h1>Load Balancing the Dark Matter Particles<a class="headerlink" href="#load-balancing-the-dark-matter-particles" title="Permalink to this headline">¶</a></h1>
<p>For Nyx, the flags which affect how the active particles get their DistributionMapping change are:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nyx</span><span class="o">.</span><span class="n">load_balance_int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">nyx</span><span class="o">.</span><span class="n">load_balance_start_z</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">nyx</span><span class="o">.</span><span class="n">load_balance_wgt_strategy</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">}</span>
<span class="n">nyx</span><span class="o">.</span><span class="n">load_balance_wgt_nmax</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">nyx</span><span class="o">.</span><span class="n">load_balance_strategy</span> <span class="o">=</span> <span class="p">{</span><span class="n">KNAPSACK</span><span class="p">,</span> <span class="n">SFC</span><span class="p">,</span> <span class="n">ROUNDROBIN</span><span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">wgt_strategy</span></code> uses either the 0=number of cells, 1=number of dark matter particles, or 2=total count of dark matter particles to determine the cost of each box. 1 and 2 should be equivalent, and 1 should be cheaper.</p>
<p>This load balancing is not on by default, and has a flag to determine based on redshift z when to begin affecting the calculation because this introduces additional communication penalties when the particles interact with mesh data. This additional communication is a trade-off to balance the amount of particle memory and particle work between ranks.</p>
<p>This strategy is not currently implemented to work for multilevel simulations.</p>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="NyxGravity.html" class="btn btn-neutral float-right" title="Gravity" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="GridCreation.html" class="btn btn-neutral float-left" title="Grid Creation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Nyx development team.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>