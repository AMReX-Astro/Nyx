

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Dark matter particles &mdash; Nyx  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/graphviz.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "tex2jax_ignore|mathjax_ignore|document", "processClass": "tex2jax_process|mathjax_process|math|output_area"}})</script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="In situ Analysis" href="InSitu.html" />
    <link rel="prev" title="Stochastic Forcing" href="NyxForcing.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Nyx
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Nyx basics</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="NyxPreface.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="NyxCitation.html">Citation</a></li>
<li class="toctree-l1"><a class="reference internal" href="NyxGettingStarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="NyxUnits.html">Units and Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="NyxInputs.html">Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="ICs.html">Initial conditions</a></li>
<li class="toctree-l1"><a class="reference internal" href="Refinement.html">Refinement Criteria</a></li>
<li class="toctree-l1"><a class="reference internal" href="ManagingGridHierarchy_Chapter.html">Gridding and Load Balancing</a></li>
<li class="toctree-l1"><a class="reference internal" href="NyxGravity.html">Gravity</a></li>
<li class="toctree-l1"><a class="reference internal" href="NyxEquations.html">Hydrodynamic Equations in Comoving Coordinates</a></li>
<li class="toctree-l1"><a class="reference internal" href="NyxSplitting.html">Hydrodynamical and Heating-Cooling Splitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="NyxHeatCool.html">Radiative Heating and Cooling</a></li>
<li class="toctree-l1"><a class="reference internal" href="NyxForcing.html">Stochastic Forcing</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Dark matter particles</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#equations">Equations</a></li>
<li class="toctree-l2"><a class="reference internal" href="#particle-time-stepping-move-kick-drift-algorithm">Particle Time Stepping: Move-Kick-Drift Algorithm</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#computing-g">Computing <strong>g</strong></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#output-format">Output Format</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="InSitu.html">In situ Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="PostProcessing.html">Analyzing Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="NightlyTests.html">Nightly Regression Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="Debugging.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="Development.html">Work in Progress</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Nyx</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Dark matter particles</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/Particles.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="dark-matter-particles">
<h1>Dark matter particles<a class="headerlink" href="#dark-matter-particles" title="Permalink to this headline">¶</a></h1>
<p>Dark matter particles are included in the simulation by setting</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nyx</span><span class="o">.</span><span class="n">do_dm_particles</span> <span class="o">=</span> <span class="n">true</span>
</pre></div>
</div>
<p>in the inputs file.</p>
<p>When dark matter particles are present, one has the option to run with or without the baryons;
to build with no hydro capability set:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NO_HYDRO</span><span class="o">=</span><span class="n">TRUE</span>
</pre></div>
</div>
<p>It is also possible to build with</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NO_HYDRO</span><span class="o">=</span><span class="n">FALSE</span>
</pre></div>
</div>
<p>but turn off hydro at run-time by setting</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nyx</span><span class="o">.</span><span class="n">do_hydro</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
<p>in the inputs file.</p>
<p>Our default is to use double precision for the mesh data and single precision for the particles; this is set in the
GNUMakefile by:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PRECISION</span> <span class="o">=</span> <span class="n">DOUBLE</span>
<span class="n">USE_SINGLE_PRECISION_PARTICLES</span> <span class="o">=</span> <span class="n">TRUE</span>
</pre></div>
</div>
<p>We do not recommend using single precision for the mesh data, as this is not tested and will potentially degrade the quality of the hydrodynamical solve. To use single precision for the mesh use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PRECISION</span> <span class="o">=</span> <span class="n">FLOAT</span>
</pre></div>
</div>
<div class="section" id="equations">
<h2>Equations<a class="headerlink" href="#equations" title="Permalink to this headline">¶</a></h2>
<p>If we define <span class="math notranslate nohighlight">\({\mathbf x}_i\)</span> and <span class="math notranslate nohighlight">\({\bf u}_i\)</span> as the location and velocity of particle <span class="math notranslate nohighlight">\(i\)</span>, respectively, then we wish
to solve</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
\frac{d {\mathbf x}_i}{d t} &amp;=&amp; \frac{1}{a} {\mathbf u}_i \\
\frac{d (a {\mathbf u}_i) }{d t} &amp;=&amp; {\mathbf g}_i\end{aligned}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\({\mathbf g}_i\)</span> is the gravitational force evaluated at the location of particle <span class="math notranslate nohighlight">\(i\)</span>, i.e.,
<span class="math notranslate nohighlight">\({\mathbf g}_i = {\mathbf g}({\mathbf x}_i,t).\)</span></p>
</div>
<div class="section" id="particle-time-stepping-move-kick-drift-algorithm">
<h2>Particle Time Stepping: Move-Kick-Drift Algorithm<a class="headerlink" href="#particle-time-stepping-move-kick-drift-algorithm" title="Permalink to this headline">¶</a></h2>
<p>In each time step:</p>
<ul class="simple">
<li>Solve for <span class="math notranslate nohighlight">\({\mathbf g}^n\)</span> (only if multilevel, otherwise use <span class="math notranslate nohighlight">\({\mathbf g}^{n+1}\)</span> from previous step)</li>
<li><span class="math notranslate nohighlight">\({\mathbf u}_i^{{n+\frac{1}{2}}} = \frac{1}{a^{{n+\frac{1}{2}}}} ( (a^n {\mathbf u}^n_i) + \frac{{\Delta t}}{2} \; {\mathbf g}^n_i )\)</span></li>
<li><span class="math notranslate nohighlight">\({\mathbf x}_i^{n+1 } = {\mathbf x}^n_i +  \frac{{\Delta t}}{a^{{n+\frac{1}{2}}}}  {\mathbf u}_i^{{n+\frac{1}{2}}}\)</span></li>
<li>Solve for <span class="math notranslate nohighlight">\({\mathbf g}^{n+1}\)</span> using <span class="math notranslate nohighlight">\({\mathbf x}_i^{n+1}\)</span></li>
<li><span class="math notranslate nohighlight">\({\mathbf u}_i^{n+1} = \frac{1}{a^{n+1}} ( (a^{{n+\frac{1}{2}}} {\mathbf u}^{{n+\frac{1}{2}}}_i) + \frac{{\Delta t}}{2} \; {\mathbf g}^{n+1}_i )\)</span></li>
</ul>
<p>Note that at the end of the timestep <span class="math notranslate nohighlight">\({\bf x}_i^{n+1}\)</span> is consistent with <span class="math notranslate nohighlight">\({\bf g}^{n+1}\)</span> becasue
we have not advanced the positions after computing the new-time gravity. This has the benefit that
we perform only one gravity solve per timestep (in a single-level calculation with no hydro) because
the particles are only moved once.</p>
<div class="section" id="computing-g">
<h3>Computing <strong>g</strong><a class="headerlink" href="#computing-g" title="Permalink to this headline">¶</a></h3>
<p>We solve for the gravitational vector as follows:</p>
<ul class="simple">
<li>Assign the mass of the particles onto the grid in the form of density, <span class="math notranslate nohighlight">\(\rho_{DM}\)</span>.
The mass of each particle is assumed to be uniformly distributed over a cube of side <span class="math notranslate nohighlight">\(\Delta x\)</span>,
centered at what we call the position of the particle. We distribute the mass of each
particle to the cells on the grid in proportion to the volume of the intersection of each cell
with the particle’s cube. We then divide these cell values by <span class="math notranslate nohighlight">\(\Delta x^3\)</span> so that the
right hand side of the Poisson solve will be in units of density rather than mass.
Note that this is the <em>comoving</em> density.</li>
<li>Solve <span class="math notranslate nohighlight">\(\nabla^2 \phi = \frac{4 \pi G}{a} \rho_{DM}\)</span>.
We discretize with the standard 7-point Laplacian (5-point in 2D)
and use multigrid with Gauss-Seidel red-black relaxation to solve the equation for <span class="math notranslate nohighlight">\(\phi\)</span> at cell centers.</li>
<li>Compute the normal component of <span class="math notranslate nohighlight">\({\bf g} = -\nabla \phi\)</span> at cell faces by differencing the adjacent values of <span class="math notranslate nohighlight">\(\phi,\)</span>
e.g. if <span class="math notranslate nohighlight">\({\bf g} = (g_x, g_y, g_z),\)</span> then we define <span class="math notranslate nohighlight">\(g_x\)</span> on cell faces with a normal in the x-direction by computing
<span class="math notranslate nohighlight">\(g_{x,i-{\frac{1}{2}},j,k} = -(\phi_{i,j,k} - \phi_{i-1,j,k}) / \Delta x.\)</span></li>
<li>Interpolate each component of <span class="math notranslate nohighlight">\({\bf g}\)</span> from normal cell faces onto each particle position using
linear interpolation in the normal direction.</li>
</ul>
</div>
</div>
<div class="section" id="output-format">
<h2>Output Format<a class="headerlink" href="#output-format" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div>The particle positions and velocities are stored in a binary file in each checkpoint directory.
This format is designed for being read by the code at restart rather than for diagnostics.
We note that the value of <span class="math notranslate nohighlight">\(a\)</span> is also written in each checkpoint directory,
in a separate ASCII file called <em>comoving_a</em>, containing only the single value.</div></blockquote>
<p>The particle positions and velocities will be written in binary files in each plotfile directory.
Dark matter particles will be in DM, active galactic nuclei particles will be in AGN,
neutrino particles will be in NPC.</p>
<blockquote>
<div><p>In addition, we can also
visualize the particle locations as represented on the grid. There are multiple “derived quantities”
which represent the particles. Including particle variables in the derived variables will make them
be written as plotfile fields on the grid, i.e.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">amr</span><span class="o">.</span><span class="n">derive_plot_vars</span> <span class="o">=</span> <span class="n">particle_count</span> <span class="n">particle_mass_density</span>
</pre></div>
</div>
<p>in the inputs file will generate plotfiles with only two variables.
<strong>particle_count</strong> represents the number of particles in a grid cell;
<strong>particle_mass_density</strong> is the density on the grid resulting from the particles.</p>
<p>The same naming convention follows for particle velocities on the grid: <strong>particle_x_velocity</strong>,
<strong>particle_y_velocity</strong>, <strong>particle_z_velocity</strong></p>
<p>Derived variables with <strong>particle_</strong> represent quantities from the Dark Matter Particle Container.
Similar variables from the AGN particle container, and the Neutrino Particle Container
are named <strong>agn_</strong> and <strong>neutrino_</strong>. Note these are particle fields written to the grid,
which are distinct from the <strong>density</strong> field in the plotfile, which is baryonic density on the grid.</p>
<p>We note that the value of <span class="math notranslate nohighlight">\(a\)</span> is also written in each plotfile directory,
in a separate ASCII file called <em>comoving_a</em>, containing only the single value.</p>
</div></blockquote>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="InSitu.html" class="btn btn-neutral float-right" title="In situ Analysis" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="NyxForcing.html" class="btn btn-neutral float-left" title="Stochastic Forcing" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Nyx development team.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>